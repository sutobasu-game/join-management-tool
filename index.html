<!DOCTYPE html>
<html lang="ja">
<head>
<title>参加管理サイト</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
/* ===== 共通（一般：男の子風） ===== */
body {
  font-family: "M PLUS Rounded 1c", sans-serif;
  background: linear-gradient(#eaf4ff, #ffffff);
  color: #334;
  margin: 0;
  padding: 12px;
}
h1, h2 { color:#5b7dbb; }

#reader {
  max-width:380px;
  margin:auto;
  background:white;
  border-radius:20px;
  padding:10px;
  box-shadow:0 8px 20px rgba(120,160,220,.25);
}

button {
  background:linear-gradient(#a9c9ff,#dbe8ff);
  border:none;
  border-radius:999px;
  padding:10px 18px;
  margin-top:8px;
  cursor:pointer;
}

input {
  padding:8px;
  border-radius:12px;
  border:1px solid #ccc;
}

table {
  width:100%;
  background:white;
  border-radius:16px;
  overflow:hidden;
  box-shadow:0 6px 16px rgba(0,0,0,.12);
}

th { background:#cfe0ff; }
td { background:#f8fbff; text-align:center; padding:6px; }

.idlink {
  color:#4a73c9;
  text-decoration:underline;
  cursor:pointer;
}

/* ===== モーダル ===== */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-content {
  background:white;
  padding:20px;
  border-radius:20px;
  width:90%;
  max-width:330px;
}

/* ===== 管理者：女の子風 ===== */
.admin-mode body {
  background: linear-gradient(#ffeaf4, #ffffff);
}
.admin-mode h1,
.admin-mode h2 { color:#c26aa0; }
.admin-mode #reader {
  box-shadow:0 8px 20px rgba(240,160,200,.35);
}
.admin-mode button {
  background:linear-gradient(#ffb7d5,#ffe0ee);
  color:#6a2c4d;
}
.admin-mode th { background:#ffd6e8; }
.admin-mode td { background:#fff6fa; }
</style>
</head>

<body>

<h1>参加管理サイト</h1>

<div id="reader"></div>

<!-- 読み取り結果 -->
<div class="modal" id="resultModal">
  <div class="modal-content">
    <h3 id="modeTitle"></h3>
    <pre id="resultText"></pre>
    <button onclick="closeResult()">閉じる</button>
  </div>
</div>

<!-- 管理者説明（最初の1回だけ） -->
<div class="modal" id="helpModal">
  <div class="modal-content">
    <h3>管理者の使い方</h3>
    <div style="font-size:14px;line-height:1.6;text-align:left">
      ・あなたは管理者です<br>
      ・名前登録、履歴削除ができます<br>
      ・参加者は1日1回のみカウント<br>
      ・毎年4月1日にリセットされます
    </div>
    <button onclick="closeHelp()">理解した</button>
  </div>
</div>

<!-- 履歴 -->
<div class="modal" id="timeModal">
  <div class="modal-content">
    <h3>参加履歴</h3>
    <div id="timeList"></div>
    <button onclick="closeTime()">閉じる</button>
  </div>
</div>

<!-- 管理者操作 -->
<div id="adminArea" style="display:none">
  <h2>管理者操作</h2>
  ID <input id="regId">
  名前 <input id="regName"><br>
  <button onclick="register()">名前登録</button>
  <button onclick="deleteHistory()">履歴削除</button>
</div>

<h2>参加一覧</h2>
<table>
<thead><tr><th>ID</th><th>名前</th><th>回数</th></tr></thead>
<tbody id="list"></tbody>
</table>

<script>
const KEY="participants";
const ADMIN_KEY="adminId";
const HELP_KEY="adminHelpShown";

let participants=JSON.parse(localStorage.getItem(KEY)||"{}");
let adminId=localStorage.getItem(ADMIN_KEY);
let isAdmin=false;
let qr;

/* 年度リセット */
(function(){
  const d=new Date();
  if(d.getMonth()==3 && d.getDate()==1 && localStorage.getItem("reset")!=d.getFullYear()){
    for(const id in participants){
      participants[id]={...participants[id],count:0,times:[],lastDate:""};
    }
    localStorage.setItem("reset",d.getFullYear());
    localStorage.setItem(KEY,JSON.stringify(participants));
  }
})();

function save(){ localStorage.setItem(KEY,JSON.stringify(participants)); render(); }

function startQR(){
  qr=new Html5Qrcode("reader");
  qr.start({facingMode:"environment"},{fps:10,qrbox:250},onScan);
}
function stopQR(){ if(qr) qr.stop(); }

function onScan(id){
  if(!/^\d+$/.test(id)) return;

  if(!adminId){
    adminId=id;
    localStorage.setItem(ADMIN_KEY,id);
    isAdmin=true;
    showResult("管理者登録","このIDが管理者です\nID："+id);
    if(!localStorage.getItem(HELP_KEY)) helpModal.style.display="flex";
    return;
  }

  isAdmin=(id===adminId);

  const now=new Date();
  const date=now.toISOString().slice(0,10);
  const time=date.replace(/-/g,"/")+" "+now.toTimeString().slice(0,8);

  if(!participants[id])
    participants[id]={name:"",count:0,times:[],lastDate:""};

  let msg="管理者モード";
  if(!isAdmin){
    if(participants[id].lastDate!==date){
      participants[id].count++;
      participants[id].times.push(time);
      participants[id].lastDate=date;
      msg="本日の参加を記録しました";
    } else msg="今日は参加済みです";
  }

  save();
  showResult(isAdmin?"管理者モード":"参加確認",
    `ID：${id}\n名前：${participants[id].name||"未登録"}\n回数：${participants[id].count}\n${msg}`);
}

function showResult(title,text){
  stopQR();
  modeTitle.innerText=title;
  resultText.innerText=text;
  document.documentElement.classList.toggle("admin-mode",isAdmin);
  adminArea.style.display=isAdmin?"block":"none";
  resultModal.style.display="flex";
}
function closeResult(){
  resultModal.style.display="none";
  document.documentElement.classList.remove("admin-mode");
  startQR();
}

function closeHelp(){
  localStorage.setItem(HELP_KEY,"yes");
  helpModal.style.display="none";
}

function showTimes(id){
  const p=participants[id];
  timeList.innerHTML=p.times.map((t,i)=>`${i+1}. ${t}`).join("<br>");
  timeModal.style.display="flex";
}
function closeTime(){ timeModal.style.display="none"; }

function register(){
  if(isAdmin && participants[regId.value]){
    participants[regId.value].name=regName.value;
    save();
  }
}
function deleteHistory(){
  if(isAdmin && participants[regId.value]){
    participants[regId.value].count=0;
    participants[regId.value].times=[];
    participants[regId.value].lastDate="";
    save();
    alert("履歴を削除しました");
  }
}

function render(){
  list.innerHTML="";
  for(const id in participants){
    const p=participants[id];
    list.innerHTML+=`
      <tr>
        <td class="idlink" onclick="showTimes('${id}')">${id}</td>
        <td>${p.name}</td>
        <td>${p.count}</td>
      </tr>`;
  }
}

render();
startQR();
</script>
</body>
</html>
